{
  "meta": {
    "instanceId": "n8n-evolution-sms-scanner"
  },
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "evolution",
        "responseMode": "responseNode"
      },
      "id": "webhook-evolution-ray",
      "name": "Evolution Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        240,
        340
      ],
      "webhookId": "evolution-webhook-ray"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.event }}",
              "rightValue": "messages.upsert",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "leftValue": "={{ $json.instance }}",
              "rightValue": "ray",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        }
      },
      "id": "filter-ray-messages",
      "name": "Filter: Instancia Ray",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        460,
        340
      ]
    },
    {
      "parameters": {
        "jsCode": "// üì± Procesar mensaje WhatsApp de instancia RAY\nconst data = $input.all()[0].json;\n\nconsole.log('üì® Webhook recibido:', JSON.stringify(data, null, 2));\n\n// Verificar que es un mensaje v√°lido\nif (!data.data || !data.data.messages || !Array.isArray(data.data.messages)) {\n  throw new Error('‚ùå Estructura de datos inv√°lida');\n}\n\nconst message = data.data.messages[0];\nconst key = message.key;\n\n// Solo procesar mensajes entrantes\nif (key.fromMe) {\n  throw new Error('‚è≠Ô∏è Mensaje enviado por nosotros, ignorar');\n}\n\n// Extraer datos del mensaje\nconst fromNumber = key.remoteJid.replace('@s.whatsapp.net', '');\nconst messageText = message.message?.conversation || \n                  message.message?.extendedTextMessage?.text || \n                  message.message?.imageMessage?.caption || \n                  'Mensaje multimedia';\n\n// Formatear n√∫mero telef√≥nico\nconst cleanPhone = fromNumber.startsWith('1') ? fromNumber : `1${fromNumber}`;\nconst formattedPhone = `+${cleanPhone}`;\n\n// Datos para crear contacto en GHL\nconst contactData = {\n  locationId: 'jtEqGdhkoR6iePmZaCmd',\n  phone: formattedPhone,\n  firstName: message.pushName || 'WhatsApp User',\n  lastName: '',\n  tags: ['whatsapp', 'evolution-api', 'sms-scanner'],\n  customField: {\n    whatsapp_name: message.pushName || '',\n    source: 'Evolution API - Ray Instance',\n    last_message_preview: messageText.substring(0, 100)\n  }\n};\n\n// Datos para el mensaje en GHL\nconst messageData = {\n  locationId: 'jtEqGdhkoR6iePmZaCmd',\n  type: 'SMS',\n  message: messageText,\n  direction: 'inbound'\n};\n\nconsole.log('‚úÖ Datos procesados para GHL:', { contactData, messageData });\n\nreturn {\n  contactData,\n  messageData,\n  phoneNumber: formattedPhone,\n  originalMessage: message,\n  timestamp: new Date().toISOString()\n};"
      },
      "id": "process-ray-message",
      "name": "Procesar Mensaje Ray",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        680,
        280
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/contacts/",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Version",
              "value": "2021-07-28"
            }
          ]
        },
        "sendBody": true,
        "contentType": "json",
        "jsonBody": "={{ JSON.stringify($json.contactData) }}"
      },
      "id": "create-ghl-contact",
      "name": "Crear Contacto GHL",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        900,
        200
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/conversations/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Version",
              "value": "2021-07-28"
            }
          ]
        },
        "sendBody": true,
        "contentType": "json",
        "jsonBody": "={\n  \"locationId\": \"{{ $json.messageData.locationId }}\",\n  \"contactId\": \"{{ $node['Crear Contacto GHL'].json.contact.id }}\",\n  \"type\": \"SMS\",\n  \"message\": \"{{ $json.messageData.message }}\",\n  \"direction\": \"inbound\"\n}"
      },
      "id": "create-ghl-message",
      "name": "Crear Mensaje GHL",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1120,
        340
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"success\": true,\n  \"message\": \"Mensaje procesado correctamente desde instancia Ray\",\n  \"data\": {\n    \"contactId\": \"{{ $node['Crear Contacto GHL'].json.contact.id }}\",\n    \"messageId\": \"{{ $node['Crear Mensaje GHL'].json.message ? $node['Crear Mensaje GHL'].json.message.id : 'N/A' }}\",\n    \"phone\": \"{{ $json.phoneNumber }}\",\n    \"timestamp\": \"{{ $json.timestamp }}\",\n    \"instance\": \"ray\"\n  }\n}"
      },
      "id": "webhook-success-response",
      "name": "Respuesta √âxito",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        1340,
        340
      ]
    },
    {
      "parameters": {
        "jsCode": "// Manejo de errores para debugging\nconst error = $input.all()[0];\nconsole.log('‚ùå ERROR en SMS Scanner Ray:', error);\n\nreturn {\n  success: false,\n  error: error.error || 'Error desconocido',\n  timestamp: new Date().toISOString(),\n  instance: 'ray'\n};"
      },
      "id": "error-handler-ray",
      "name": "Manejo Errores",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        680,
        460
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"success\": false,\n  \"message\": \"Error procesando mensaje de WhatsApp\",\n  \"error\": \"{{ $json.error }}\",\n  \"timestamp\": \"{{ $json.timestamp }}\",\n  \"instance\": \"ray\"\n}"
      },
      "id": "error-response",
      "name": "Respuesta Error",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        900,
        460
      ]
    }\n  ],\n  \"connections\": {\n    \"Evolution Webhook\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Filter: Instancia Ray\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Filter: Instancia Ray\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Procesar Mensaje Ray\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ],\n        [\n          {\n            \"node\": \"Manejo Errores\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Procesar Mensaje Ray\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Crear Contacto GHL\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Crear Contacto GHL\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Crear Mensaje GHL\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Crear Mensaje GHL\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Respuesta √âxito\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Manejo Errores\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Respuesta Error\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    }\n  },\n  \"pinData\": {},\n  \"settings\": {\n    \"executionOrder\": \"v1\"\n  },\n  \"staticData\": null,\n  \"tags\": [\n    \"whatsapp\",\n    \"evolution-api\",\n    \"gohighlevel\",\n    \"sms-scanner\",\n    \"ray\"\n  ],\n  \"triggerCount\": 1,\n  \"updatedAt\": \"2025-01-22T12:00:00.000Z\",\n  \"versionId\": \"1\"\n}"
      }
    }
  ],
  "connections": {
    "Evolution Webhook": {
      "main": [
        [
          {
            "node": "Filter: Instancia Ray",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter: Instancia Ray": {
      "main": [
        [
          {
            "node": "Procesar Mensaje Ray",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Manejo Errores",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Mensaje Ray": {
      "main": [
        [
          {
            "node": "Crear Contacto GHL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crear Contacto GHL": {
      "main": [
        [
          {
            "node": "Crear Mensaje GHL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crear Mensaje GHL": {
      "main": [
        [
          {
            "node": "Respuesta √âxito",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Manejo Errores": {
      "main": [
        [
          {
            "node": "Respuesta Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    "whatsapp",
    "evolution-api", 
    "gohighlevel",
    "sms-scanner",
    "ray"
  ],
  "triggerCount": 1,
  "updatedAt": "2025-01-22T12:00:00.000Z",
  "versionId": "1"
}